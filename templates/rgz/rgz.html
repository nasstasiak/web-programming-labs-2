{% extends "base.html" %}
{% block lab %}Расчетно-графическая работа{% endblock %}
<style>
    body,
    html,
    main {
        overflow: scroll;
    }

    img {
        margin: 0;
    }

    .pagination {
        margin-top: 20px;
        display: flex;
        justify-content: center;
        gap: 10px;
    }

    .pagination button {
        padding: 10px 20px;
        cursor: pointer;
    }
</style>
{% block main %}
    <a href="/index">&#128072;</a>
    <h2>Список книг</h2>
    <table border="1">
        <thead>
            <tr>
                <th>Обложка</th>
                <th>Название</th>
                <th>Автор</th>
                <th>Страницы</th>
                <th>Издательство</th>
            </tr>
        </thead>
        <tbody id="books">
            <!-- Здесь будут отображаться книги -->
        </tbody>
    </table>

    <div style="margin-top: 20px;">
        <a href="/login">Вход для администратора</a>
    </div>

    <!-- Пагинация -->
    <div class="pagination">
        <button id="prev-page" onclick="changePage(-1)">Предыдущая</button>
        <button id="next-page" onclick="changePage(1)">Следующая</button>
    </div>

    <br><br><br>
    <script>
        let currentPage = 1; // Текущая страница
        const booksPerPage = 20; // Количество книг на странице
        let allBooks = []; // Массив для хранения всех книг

        // Функция для получения списка книг
        async function fetchBooks() {
            try {
                const response = await fetch('/rgz/json-rpc-api/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        method: 'get_books',
                        id: 1
                    })
                });
                if (!response.ok) {
                    throw new Error('Ошибка при загрузке данных');
                }
                const data = await response.json();
                if (data.result) {
                    allBooks = data.result; // Сохраняем все книги в массив
                    displayBooks(currentPage); // Отображаем книги для текущей страницы
                }
            } catch (error) {
                console.error('Ошибка:', error);
                alert('Не удалось загрузить список книг. Попробуйте позже.');
            }
        }

        // Функция для отображения книг на текущей странице
        function displayBooks(page) {
            const booksTable = document.getElementById('books');
            booksTable.innerHTML = '';

            // Вычисляем диапазон книг для текущей страницы
            const startIndex = (page - 1) * booksPerPage;
            const endIndex = startIndex + booksPerPage;
            const booksToDisplay = allBooks.slice(startIndex, endIndex);

            // Отображаем книги
            booksToDisplay.forEach(book => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><img src="${book.cover_image}" alt="${book.title}" width="100"></td>
                    <td>${book.title}</td>
                    <td>${book.author}</td>
                    <td>${book.pages}</td>
                    <td>${book.publisher}</td>
                `;
                booksTable.appendChild(row);
            });

            // Проверяем, нужно ли отключить кнопки пагинации
            const prevButton = document.getElementById('prev-page');
            const nextButton = document.getElementById('next-page');
            prevButton.disabled = page === 1; // Отключаем "Предыдущая", если это первая страница
            nextButton.disabled = endIndex >= allBooks.length; // Отключаем "Следующая", если это последняя страница
        }

        // Функция для изменения страницы
        function changePage(offset) {
            currentPage += offset;
            if (currentPage < 1) {
                currentPage = 1; // Не позволяем уйти на страницу меньше 1
            } else if (currentPage > Math.ceil(allBooks.length / booksPerPage)) {
                currentPage = Math.ceil(allBooks.length / booksPerPage); // Не позволяем уйти на страницу больше максимальной
            }
            displayBooks(currentPage);
        }

        // Загрузка книг при загрузке страницы
        fetchBooks();
    </script>
{% endblock %}