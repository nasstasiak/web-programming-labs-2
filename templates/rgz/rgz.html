{% extends "base.html" %}
{% block lab %}Расчетно-графическая работа{% endblock %}
{% block script %}
<style>
    /* Пагинация */
    .pagination {
        margin-top: 20px;
        display: flex;
        justify-content: center;
        gap: 10px;
    }

    .pagination button {
        
        cursor: pointer;
    }
    
</style>

{% endblock %}
{% block main %}
    <a href="/index">&#128072;</a>
    <h2>Список книг</h2>
    <table border="1">
        <thead>
            <tr>
                <th>Обложка</th>
                <th>Название</th>
                <th>Автор</th>
                <th>Страницы</th>
                <th>Издательство</th>
            </tr>
        </thead>
        <tbody id="books">
            <!-- Здесь будут отображаться книги -->
        </tbody>
    </table>

    <div style="margin-top: 20px;">
        <a href="/login">Вход для администратора</a>
    </div>

    <!-- Пагинация -->
    <div class="pagination" id="pagination">
        <!-- Здесь будут кнопки для страниц -->
    </div>

    <br><br><br>
    <script>
        let currentPage = 1; // Текущая страница
        const booksPerPage = 20; // Количество книг на странице
        let allBooks = []; // Массив для хранения всех книг

        // Функция для получения списка книг
        async function fetchBooks() {
            try {
                const response = await fetch('/rgz/json-rpc-api/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        method: 'get_books',
                        id: 1
                    })
                });
                if (!response.ok) {
                    throw new Error('Ошибка при загрузке данных');
                }
                const data = await response.json();
                if (data.result) {
                    allBooks = data.result.sort((a, b) => a.id - b.id); // Сортировка по id
                    displayBooks(currentPage); // Отображаем книги для текущей страницы
                    updatePagination(); // Обновляем пагинацию
                }
            } catch (error) {
                console.error('Ошибка:', error);
                alert('Не удалось загрузить список книг. Попробуйте позже.');
            }
        }

        // Функция для отображения книг на текущей странице
        function displayBooks(page) {
            const booksTable = document.getElementById('books');
            booksTable.innerHTML = '';

            // Вычисляем диапазон книг для текущей страницы
            const startIndex = (page - 1) * booksPerPage;
            const endIndex = startIndex + booksPerPage;
            const booksToDisplay = allBooks.slice(startIndex, endIndex);

            // Отображаем книги
            booksToDisplay.forEach(book => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><img src="${book.cover_image}" alt="${book.title}" width="100"></td>
                    <td>${book.title}</td>
                    <td>${book.author}</td>
                    <td>${book.pages}</td>
                    <td>${book.publisher}</td>
                `;
                booksTable.appendChild(row);
            });

            // Обновляем текущую страницу
            currentPage = page;
        }

        // Функция для обновления пагинации
        function updatePagination() {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            const totalPages = Math.ceil(allBooks.length / booksPerPage);

            // Кнопка "Предыдущая"
            const prevButton = document.createElement('button');
            prevButton.textContent = 'Предыдущая';
            prevButton.disabled = currentPage === 1;
            prevButton.onclick = () => changePage(currentPage - 1);
            pagination.appendChild(prevButton);

            // Кнопки для страниц
            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.onclick = () => changePage(i);
                if (i === currentPage) {
                    pageButton.classList.add('active'); // Подсвечиваем текущую страницу
                }
                pagination.appendChild(pageButton);
            }

            // Кнопка "Следующая"
            const nextButton = document.createElement('button');
            nextButton.textContent = 'Следующая';
            nextButton.disabled = currentPage === totalPages;
            nextButton.onclick = () => changePage(currentPage + 1);
            pagination.appendChild(nextButton);
        }

        // Функция для изменения страницы
        function changePage(page) {
            if (page < 1 || page > Math.ceil(allBooks.length / booksPerPage)) {
                return; // Не позволяем уйти за пределы страниц
            }
            currentPage = page;
            displayBooks(currentPage);
            updatePagination();
        }

        // Загрузка книг при загрузке страницы
        fetchBooks();
    </script>
{% endblock %}